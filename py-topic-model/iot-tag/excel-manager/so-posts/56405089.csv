thread_ID, Id, ParentId, PostType, Score, CreationDate, OwnerID, Body
56405089,56405089,null,1,2,Sat Jun 01 08:31:00 EDT 2019,5077196,"<p>I have an application where each client has its own thing, for each thing I am creating a certificate and attaching it to the thing, I am also attaching the following policy to the certificate.</p>		<pre><code>{	  "Version": "2012-10-17",	  "Statement": [	    {	      "Effect": "Allow",	      "Action": "iot:*",	    "Resource": ["arn:aws:iot:us-east-1:*********:topic/${iot:Connection.Thing.ThingName}"]	    }	  ]	}	</code></pre>		<p>What I want to do is limit a client from accessing other clients' things, and each client can have full access to its thing topic.</p>		<p>The above policy isn't working, clients aren't able to connect at all.	However the following is working (in terms of functionality), but clients are able to publish to all topics.</p>		<pre><code>{	  "Version": "2012-10-17",	  "Statement": [	    {	      "Effect": "Allow",	      "Action": "iot:*",	      "Resource": "*"	    }	  ]	}	</code></pre>		<p>Also the following connects successfully but fails to publish:</p>		<pre><code>{	  "Version": "2012-10-17",	  "Statement": [	    {	      "Effect": "Allow",	      "Action": "iot:Connect",	      "Resource": "*"	    },	    {	      "Effect": "Allow",	      "Action": "iot:Publish",	      "Resource": [	        "arn:aws:iot:us-east-1:******:topic/${iot:Connection.Thing.ThingName}"	      ]	    }	  ]	}	</code></pre>		<p>Finally the following connects and publishes successfully.</p>		<pre><code>{	  "Version": "2012-10-17",	  "Statement": [	    {	      "Effect": "Allow",	      "Action": "iot:Connect",	      "Resource": "*"	    },	    {	      "Effect": "Allow",	      "Action": "iot:Publish",	      "Resource": [	        "arn:aws:iot:us-east-1:******:topic/*"	      ]	    }	  ]	}	</code></pre>		<p>MQTTBox client configs:	<a href="https://i.stack.imgur.com/xu4St.png" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/xu4St.png" alt="client configs"></a></p>		<p>Publisher:	<a href="https://i.stack.imgur.com/rFFXR.png" rel="nofollow noreferrer"><img src="https://i.stack.imgur.com/rFFXR.png" alt="publisher settings"></a></p>		<p>What am I doing wrong?</p>	"
56405089,56455759,56405089,2,1,Wed Jun 05 07:13:00 EDT 2019,1373856,"<p>The policy needs an explicit <code>iot:Connect</code> statement to allow connections to a <code>client</code> resource.</p>		<p>The relevant <code>client</code> resource is documented at <a href="https://docs.aws.amazon.com/iot/latest/developerguide/action-resources.html" rel="nofollow noreferrer">https://docs.aws.amazon.com/iot/latest/developerguide/action-resources.html</a> as</p>		<blockquote>	  <p>A client ID ARN - arn:aws:iot:us-east1:123456789012:client/myClientId </p>	</blockquote>		<p>For a thing that is registered in the AWS IoT registry, you can use:</p>		<pre><code>{	  "Version": "2012-10-17",	  "Statement": [	    {	      "Effect": "Allow",	      "Action": "iot:Connect",	      "Resource": ["arn:aws:iot:us-east-1:*********:client/${iot:Connection.Thing.ThingName}"]	    },	    {	      "Effect": "Allow",	      "Action": "iot:*",	      "Resource": ["arn:aws:iot:us-east-1:*********:topic/${iot:Connection.Thing.ThingName}"]	    }	  ]	}	</code></pre>		<p>e.g. This example will allow a thing with client id of <code>ThingId123</code> to publish to a topic named <code>ThingId123</code>.</p>		<p>See also <a href="https://docs.aws.amazon.com/iot/latest/developerguide/pub-sub-policy.html" rel="nofollow noreferrer">https://docs.aws.amazon.com/iot/latest/developerguide/pub-sub-policy.html</a> for an example that appears to closely align to your needs.</p>	"
56405089,99656979,56455759,3,0,Tue Jun 11 06:10:00 EDT 2019,5077196,"Using your solution, the client couldn't connect or publish"
56405089,99657169,56455759,3,0,Tue Jun 11 06:18:00 EDT 2019,1373856,"So what happens if you replace `${iot:Connection.Thing.ThingName}` in the policy with the actual thing name?"
56405089,99657363,56455759,3,0,Tue Jun 11 06:26:00 EDT 2019,5077196,"doesn't work either.	My thing name is thingy1 so I replaced ${iot:Connection.Thing.ThingName} with thingy1, I feel like I am doing something ridiculous  causing this"
56405089,99657767,56455759,3,0,Tue Jun 11 06:41:00 EDT 2019,1373856,"Is your thing's client id the same as the thing name?"
56405089,99658085,56455759,3,0,Tue Jun 11 06:52:00 EDT 2019,5077196,"I added screenshots from MQTTbox, policy is * for connect and  "arn:aws:iot:us-east-1:******:topic/thingy1" for publish, it connects but doesn't publish"
56405089,99727893,56455759,3,0,Thu Jun 13 06:58:00 EDT 2019,5077196,"connect works with ${iot:ClientId}, but publish works only with * or thingy1, it is like thing is not registered, but I added it from manage things in IOT core"
56405089,99652673,56455759,3,0,Tue Jun 11 00:10:00 EDT 2019,1373856,"How didn't it work? Is it the client can't connect or can't publish?		From your recent edits I would check that the topic path matches your thing name."
56405089,99629532,56455759,3,0,Mon Jun 10 08:10:00 EDT 2019,5077196,"thank you, but that didn't work either. I am using MQTTBox to test, only the action which's Resource is set to (*) is working"
56405089,99722762,56455759,3,0,Thu Jun 13 01:04:00 EDT 2019,1373856,"The topic that you need to publish to is just `thingy1`. The 'Topic to publish' entry in MQTTBox should not contain the `arn:aws:iot:us-east-1:******:topic/` part. See some of the examples in https://docs.aws.amazon.com/iot/latest/developerguide/pub-sub-policy.html"
56405089,99722855,56455759,3,0,Thu Jun 13 01:12:00 EDT 2019,1373856,"For the connect part of the policy to work (with my example and not using *) then the thing needs to be registered in the AWS IoT registry."
56405089,99722921,56455759,3,0,Thu Jun 13 01:18:00 EDT 2019,1373856,"As an alternative you can use `${iot:ClientId}` in place of `${iot:Connection.Thing.ThingName}`"
